name: Crossbow

on:
  push:
    branches:
      - "revdep-test"

jobs:
  test-vcpkg-win:
    env:
      VCPKG_BINARY_SOURCES: 'clear;nuget,GitHub,readwrite'
    name: Install build deps with vcpkg and build Arrow C++
    runs-on: windows-2019
    steps:
      - name: Checkout Arrow
        run: |
          git clone --no-checkout https://github.com/apache/arrow.git arrow
          git -C arrow fetch -t https://github.com/apache/arrow.git master
          git -C arrow checkout FETCH_HEAD
          git -C arrow submodule update --init --recursive
      - name: Download Timezone Database
        shell: bash
        run: arrow/ci/scripts/download_tz_database.sh
      - name: Remove and Reinstall vcpkg
        # When running vcpkg in Github Actions on Windows, remove the
        # preinstalled vcpkg and install the newest version from source.
        # Versions of vcpkg rapidly stop working until updated, and
        # the safest and most reliable way to update vcpkg is simply
        # to remove and reinstall it.
        shell: cmd
        run: |
          CALL vcpkg integrate remove 2>NUL
          CALL C:
          CALL cd \
          CALL rmdir /s /q vcpkg 2>NUL
          CALL git clone https://github.com/microsoft/vcpkg.git vcpkg
          CALL cd vcpkg
          CALL bootstrap-vcpkg.bat -win64 -disableMetrics
          CALL vcpkg integrate install
          CALL setx PATH "%PATH%;C:\vcpkg"
      - name: 'Setup NuGet Credentials'
        shell: bash
        env: 
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          vcpkg fetch nuget | tail -n 1
          sources add
          -source "https://nuget.pkg.github.com/ursacomputing/index.json"
          -storepasswordincleartext
          -name "GitHub"
          -username "ursacomputing"
          -password "$GITHUB_TOKEN"
      - name: Install Dependencies with vcpkg and Build Arrow C++
        shell: cmd
        run: |
          CALL cd arrow
          CALL dev\tasks\vcpkg-tests\cpp-build-vcpkg.bat
